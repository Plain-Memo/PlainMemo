<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Plain Memo</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-color:#121212;
      --gutter-bg:#1a1a1a;
      --text-color:#e0e0e0;
      --line-number-color:#555;
      --accent-color:#ffffff;
      --highlight-line-bg:#252525;
      --font-family:'JetBrains Mono', monospace;
      --line-height-mult:1.6;
      --base-font-size: 16px;
      --ui-bg:#1a1a1a;
      --ui-border:#222;
    }

    body, html{
      margin:0; padding:0; height:100%;
      background-color:var(--bg-color);
      color:var(--text-color);
      font-family:var(--font-family);
      overflow:hidden;
      position:fixed;
      width:100%;
    }

    .container{
      display:flex;
      height:calc(100svh - 35px);
      width:100%;
      position:relative;
    }

    #line-numbers{
      width:50px;
      padding:20px 0;
      text-align:right;
      background-color:var(--gutter-bg);
      color:var(--line-number-color);
      user-select:none;
      overflow:hidden;
      border-right:1px solid #222;
      white-space:pre;
      pointer-events:none;
      box-sizing:border-box;
      font-size: var(--base-font-size);
      line-height: calc(var(--base-font-size) * var(--line-height-mult));
      z-index:0;
    }

    #editor{
      flex:1;
      padding:20px;
      border:none;
      outline:none;
      background:transparent;
      color:inherit;
      font-family:inherit;
      font-size: var(--base-font-size);
      line-height: var(--line-height-mult);
      resize:none;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-appearance:none;
      caret-color:var(--accent-color);
      z-index:2;
      box-sizing:border-box;
      /* Auto Wrap */
      white-space: pre-wrap;
      word-break: break-all;
    }

    #current-line{
      position:absolute;
      top:0; left:0; right:0;
      height: calc(var(--base-font-size) * var(--line-height-mult));
      background:var(--highlight-line-bg);
      opacity:0.85;
      pointer-events:none;
      z-index:1;
      transform:translateY(-9999px);
    }

    .status-bar{
      height:35px;
      background:var(--ui-bg);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 15px;
      font-size:11px;
      color:#777;
      border-top:1px solid var(--ui-border);
      box-sizing:border-box;
    }

    .controls button{
      background:transparent;
      border:1px solid #444;
      color:#aaa;
      padding:3px 10px;
      cursor:pointer;
      font-size:10px;
      border-radius:2px;
    }

    #toast{
      position:fixed; bottom:60px; left:50%;
      transform:translateX(-50%);
      background:#1f1f1f; color:#fff;
      padding:8px 16px; font-size:12px;
      border-radius:6px; opacity:0;
      pointer-events:none; transition:0.25s;
      border:1px solid #333; z-index:999;
    }
    #toast.show{ opacity:1; }

    #mirror{
      position:absolute; top:-9999px; left:-9999px; visibility:hidden;
      white-space:pre-wrap; word-break:break-all;
      font-size: var(--base-font-size);
      line-height: var(--line-height-mult);
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="line-numbers">1</div>
    <div id="current-line"></div>
    <textarea id="editor" spellcheck="false" autocomplete="off" placeholder="Start typing..."></textarea>
  </div>

  <div class="status-bar">
    <div style="font-weight:500; color:#999; letter-spacing:1px;">PLAIN MEMO</div>
    <div class="controls" style="display:flex; gap:15px; align-items:center;">
      <span id="stats">LN: 1 | CH: 0</span>
      <button onclick="downloadText()">Export</button>
    </div>
  </div>

  <div id="toast"></div>
  <div id="mirror"></div>

  <script>
    const editor = document.getElementById('editor');
    const lineNumbers = document.getElementById('line-numbers');
    const stats = document.getElementById('stats');
    const toastEl = document.getElementById('toast');
    const currentLineEl = document.getElementById('current-line');
    const mirror = document.getElementById('mirror');

    const DATA_KEY = 'plain-memo-data-v1';

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1200);
    }

    function updateEditor(){
      const text = editor.value;
      const lines = text.split('\n').length;
      let numbers = "";
      for (let i = 1; i <= lines; i++) numbers += i + "\n";
      lineNumbers.textContent = numbers;
      stats.innerText = `LN: ${lines} | CH: ${text.length}`;
      localStorage.setItem(DATA_KEY, text);
    }

    function syncMirrorStyle(){
      const cs = getComputedStyle(editor);
      mirror.style.width = cs.width;
      mirror.style.padding = cs.padding;
      mirror.style.boxSizing = cs.boxSizing;
    }

    function getCaretVisualTop(){
      const pos = editor.selectionStart || 0;
      const text = editor.value;
      mirror.innerHTML = text.slice(0, pos).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) + '<span id="caret-marker">|</span>';
      const marker = document.getElementById('caret-marker');
      return marker ? marker.offsetTop : 0;
    }

    function updateCurrentLineHighlight(){
      const gutterWidth = lineNumbers.getBoundingClientRect().width;
      currentLineEl.style.left = gutterWidth + "px";
      const y = getCaretVisualTop() - editor.scrollTop;
      currentLineEl.style.transform = `translateY(${Math.round(y)}px)`;
    }

    function getFormattedTimestamp() {
      const now = new Date();
      const pad = (n) => n.toString().padStart(2, '0');
      const Y = now.getFullYear();
      const M = pad(now.getMonth() + 1);
      const D = pad(now.getDate());
      const h = pad(now.getHours());
      const m = pad(now.getMinutes());
      const s = pad(now.getSeconds());
      return `${Y}${M}${D}${h}${m}${s}`;
    }

    function downloadText(){
      if (!editor.value) return showToast("Empty");
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, editor.value], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `Memo_${getFormattedTimestamp()}.txt`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 100);
      showToast("âœ” Exported");
    }

    editor.addEventListener('input', () => { updateEditor(); updateCurrentLineHighlight(); });
    editor.addEventListener('scroll', () => {
      lineNumbers.scrollTop = editor.scrollTop;
      updateCurrentLineHighlight();
    });

    ['click','keyup','select'].forEach(ev => editor.addEventListener(ev, updateCurrentLineHighlight));
    window.addEventListener('resize', () => { syncMirrorStyle(); updateCurrentLineHighlight(); });

    editor.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); downloadText(); }
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart;
        editor.value = editor.value.substring(0, start) + "    " + editor.value.substring(editor.selectionEnd);
        editor.selectionStart = editor.selectionEnd = start + 4;
        updateEditor();
        updateCurrentLineHighlight();
      }
    });

    window.onload = () => {
      editor.value = localStorage.getItem(DATA_KEY) || "";
      syncMirrorStyle();
      updateEditor();
      if (!('ontouchstart' in window)) editor.focus();
    };
  </script>
</body>
</html>